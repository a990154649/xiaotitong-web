<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¶ˆé¢˜é€š - å®˜æ–¹æˆæƒç‰ˆ</title>
    <style>
        :root { --primary: #e63946; --secondary: #1d3557; --bg: #f8f9fa; --success: #2a9d8f; }
        body { font-family: system-ui, -apple-system, sans-serif; margin: 0; background: var(--bg); color: var(--secondary); -webkit-user-select: none; }
        .header { background: linear-gradient(135deg, var(--primary), #b91d1d); color: white; padding: 25px 20px; text-align: center; border-radius: 0 0 25px 25px; position: relative; }
        .logout-btn { position: absolute; right: 15px; top: 25px; font-size: 13px; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 8px; cursor: pointer; }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.06); position: relative; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn { border: none; padding: 18px; border-radius: 12px; font-size: 15px; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; transition: 0.2s; }
        .btn:active { transform: scale(0.95); opacity: 0.9; }
        .btn-blue { background: #457b9d; color: white; }
        .btn-purple { background: #6a4c93; color: white; }
        .btn-red { background: var(--primary); color: white; }
        .btn-green { background: var(--success); color: white; }
        .btn-gray { background: #6c757d; color: white; }
        .btn-orange { background: #f4a261; color: white; }
        .btn-block { width: 100%; }

        #login-page, #admin-page { position: fixed; inset: 0; background: white; z-index: 1000; padding: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow-y: auto; }
        input, select { width: 100%; padding: 15px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; background: white; }
        .hidden { display: none !important; }

        .opt { padding: 15px; border: 2px solid #f0f0f0; margin-bottom: 10px; border-radius: 12px; transition: 0.2s; cursor: pointer; display: flex; align-items: center; }
        .opt.selected { border-color: var(--primary); background: #fff5f5; }
        .opt.sel-ok { background: #d1fae5; border-color: #10b981; color: #065f46; }
        .opt.sel-no { background: #fee2e2; border-color: #ef4444; color: #991b1b; }
        .lock { pointer-events: none; }

        #result-box { margin-top: 20px; padding: 15px; background: #f8f9fa; border: 2px dashed var(--primary); border-radius: 10px; width: 100%; box-sizing: border-box; text-align: center; }
        #code-text { cursor: pointer; user-select: all; -webkit-user-select: all; }

        .remember-box { width: 100%; display: flex; align-items: center; margin-bottom: 15px; font-size: 14px; color: #666; justify-content: flex-start; }
        .remember-box input { width: 18px !important; height: 18px !important; margin: 0 8px 0 0 !important; cursor: pointer; }

        #loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .progress-bar { width: 80%; height: 12px; background: #333; border-radius: 6px; margin-top: 20px; overflow: hidden; }
        .progress-inner { width: 0%; height: 100%; background: #fff; box-shadow: 0 0 15px #fff; transition: width 0.1s; }

        .fav-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #ccc; transition: 0.2s; z-index: 10; }
        .fav-btn.active { color: #f4a261; }
        .remove-btn { position: absolute; top: 18px; right: 60px; font-size: 12px; color: var(--primary); cursor: pointer; border: 1px solid var(--primary); padding: 2px 8px; border-radius: 6px; z-index: 10; font-weight: normal; }

        .device-info { font-size: 11px; color: #999; margin-top: 10px; background: #eee; padding: 5px 10px; border-radius: 5px; cursor: pointer; }

        /* ç­”é¢˜å¡ç½‘æ ¼ */
        .nav-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px; margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
        .nav-item { aspect-ratio: 1; border: 1px solid #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #999; cursor: pointer; }
        .nav-item.done { background: var(--secondary); color: white; border-color: var(--secondary); }
        .nav-item.current { border: 2px solid var(--primary); color: var(--primary); font-weight: bold; }

        .history-list { max-height: 200px; overflow-y: auto; margin-top: 10px; }
        .history-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; font-size: 14px; cursor: pointer; }
        .wrong-list-item { border-bottom: 1px solid #eee; padding: 15px 0; }
        .wrong-q-body { font-weight: bold; margin-bottom: 10px; font-size: 16px; line-height: 1.4; }
        .wrong-q-ans { color: var(--success); font-size: 14px; font-weight: bold; background: #f0fff4; padding: 5px; border-radius: 5px; display: inline-block; }
    </style>
</head>
<body>

<div id="loading-overlay" class="hidden">
    <div style="font-size: 50px;">ğŸš€</div>
    <div id="loading-txt" style="margin-top:10px; font-weight:bold;">æ­£åœ¨å¤„ç†é¢˜åº“...</div>
    <div class="progress-bar"><div id="progress-inner" class="progress-inner"></div></div>
    <div id="progress-txt" style="margin-top:10px; font-size:12px;">0%</div>
</div>

<div id="login-page">
    <div style="font-size: 60px;">ğŸ›¡ï¸</div>
    <h1 style="color: var(--primary); margin: 10px 0;">æ¶ˆé¢˜é€š</h1>
    <p style="color: #666; font-size: 13px; margin-bottom: 20px;">è¯·è”ç³»ç®¡ç†å‘˜è·å–æˆæƒç è¿›å…¥</p>
    <input type="text" id="uname" placeholder="å­¦å‘˜å§“å">
    <input type="text" id="upass" placeholder="è¯·è¾“å…¥å”¯ä¸€æˆæƒç ">
    <div class="remember-box">
        <input type="checkbox" id="remember-me">
        <label for="remember-me">è®°ä½å§“åå’Œæˆæƒç </label>
    </div>
    <button class="btn btn-red btn-block" onclick="login()">æ¿€æ´»å¹¶è¿›å…¥</button>
    <div class="device-info" onclick="copyDeviceId()">æœ¬æœºåºåˆ—å·: <span id="my-device-id-display">è·å–ä¸­...</span> (ç‚¹å‡»å¤åˆ¶)</div>
    <p onclick="showAdmin()" style="margin-top: 25px; color: #f8f9fa; font-size: 10px; cursor: pointer;">A</p>
</div>

<!-- ç®¡ç†é¡µ -->
<div id="admin-page" class="hidden">
    <h2 style="color: var(--secondary)">ğŸ›¡ï¸ æˆæƒä¸­å¿ƒ (ç®¡ç†å‘˜)</h2>
    <div class="card" style="width: 100%; box-sizing: border-box;">
        <input type="text" id="gen-name" placeholder="å­¦å‘˜å§“å">
        <input type="text" id="gen-sid" placeholder="å­¦å‘˜æ‰‹æœºåºåˆ—å·">
        <select id="gen-course">
            <option value="1">ä¸­çº§-ç›‘æ§å²—</option>
            <option value="2">ä¸­çº§-æ¶ˆé˜²ç»´ä¿</option>
            <option value="3">å…¨èƒ½é€š (åŒé¢˜åº“)</option>
        </select>
        <button class="btn btn-red btn-block" onclick="doGenerateCode()">ç”Ÿæˆå”¯ä¸€æˆæƒç </button>
        <div id="result-box" class="hidden">
            <div style="font-size: 12px; color: #666;">ç”Ÿæˆçš„æˆæƒç  (ç‚¹å‡»è‡ªåŠ¨å¤åˆ¶)ï¼š</div>
            <div id="code-text" style="font-size: 16px; font-weight: bold; color: var(--primary); margin-top: 10px; word-break: break-all;" onclick="copyCode()"></div>
        </div>
    </div>
    <button class="btn btn-gray btn-block" style="margin-top: 20px;" onclick="goHomeFromAdmin()">è¿”å›ç™»å½•ç•Œé¢</button>
</div>

<!-- è€ƒè¯•å›é¡¾é¡µé¢ -->
<div id="history-detail-page" class="hidden" style="position:fixed; inset:0; background:white; z-index:1100; padding:20px; display: block; overflow-y: scroll; -webkit-overflow-scrolling: touch;">
    <div style="display:flex; align-items:center; background:white; position:sticky; top:0; padding:10px 0; border-bottom:1px solid #eee; z-index:100;">
        <button class="btn btn-gray" style="padding:8px 15px; width:auto; font-size:14px;" onclick="closeHistoryDetail()">â† è¿”å›</button>
        <h3 style="flex-grow:1; text-align:center; margin:0; font-size:18px;">è€ƒé¢˜å›é¡¾</h3>
    </div>
    <div id="wrong-questions-container"></div>
</div>

<div id="main-content" class="hidden">
    <div class="header">
        <h2 style="margin:0">æ¶ˆé¢˜é€š</h2>
        <div id="sub-title" style="font-size: 12px; opacity: 0.9; margin-top: 5px;"></div>
        <div class="logout-btn" onclick="logout()">æ³¨é”€</div>
    </div>
    <div class="container">
        <div id="home-view">
            <div class="card" style="background: var(--secondary); color: white;">
                <h3>ä½ å¥½ï¼Œ<span id="welcome-name"></span></h3>
                <p style="font-size: 12px; opacity: 0.8; margin-top: 5px;">æˆæƒæˆåŠŸï¼Œå®˜æ–¹æ­£ç‰ˆ</p>
            </div>
            <div id="cate-switcher" class="hidden" style="margin-bottom: 15px;">
                <select id="user-cate-select" onchange="switchCate(this.value)" style="border: 2px solid var(--primary);">
                    <option value="jk">å½“å‰ï¼šç›‘æ§å²—é¢˜åº“</option>
                    <option value="wb">å½“å‰ï¼šæ¶ˆé˜²ç»´ä¿é¢˜åº“</option>
                </select>
            </div>
            <div class="menu-grid">
                <button class="btn btn-blue" onclick="start('practice')">ğŸ“– é¡ºåºç»ƒä¹ </button>
                <button class="btn btn-blue" style="background:#219ebc" onclick="start('random_practice')">ğŸ”€ éšæœºç»ƒä¹ </button>
                <button class="btn btn-purple" onclick="start('memorize')">ğŸ’¡ é¡ºåºèƒŒé¢˜</button>
                <button class="btn btn-purple" style="background:#8e94f2" onclick="start('random_memorize')">ğŸ² éšæœºèƒŒé¢˜</button>
                <button class="btn btn-red" onclick="start('exam')">ğŸ“ æ¨¡æ‹Ÿè€ƒè¯•</button>
                <button class="btn btn-orange" onclick="start('wrong')">âŒ é”™é¢˜æœ¬</button>
                <button class="btn btn-green" onclick="start('fav')">â­ æ”¶è—å¤¹</button>
                <button class="btn btn-gray" style="background:#2a9d8f; color:white" onclick="showImportSyncMenu()">ğŸ”„ å¯¼å…¥é¢˜åº“</button>
                <button class="btn btn-blue" style="background:#2196F3; color:white; grid-column: span 2" onclick="showUpdateDialog()">ğŸ—„ï¸ æ›´æ–°é¢˜åº“</button>
            </div>
            <input type="file" id="local-file-input" accept=".txt" style="display:none" onchange="handleLocalFile(this)">

            <!-- å†å²è®°å½•å±•ç¤ºåŒº -->
            <div class="card" style="margin-top: 20px;">
                <h4>ğŸ† å†å²è€ƒåˆ† (ç‚¹å‡»å›é¡¾é”™é¢˜)</h4>
                <div id="history-list" class="history-list">æš‚æ— è®°å½•</div>
            </div>

            <!-- æ›´æ–°é¢˜åº“å¯¹è¯æ¡† -->
            <div id="updateDialog" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1200; display:flex; align-items:center; justify-content:center;">
                <div style="background:white; border-radius:20px; padding:30px; width:90%; max-width:400px; text-align:center;">
                    <h3 style="margin-top:0; color:var(--primary)">é€‰æ‹©è¦æ›´æ–°çš„é¢˜åº“</h3>
                    <div style="margin:20px 0;">
                        <button class="btn btn-blue btn-block" onclick="updateExam('jk')">ç›‘æ§å²—ä¸­çº§</button>
                        <button class="btn btn-blue btn-block" style="margin-top:10px; background:#2196F3" onclick="updateExam('wb')">æ¶ˆé˜²ç»´ä¿ä¸­çº§</button>
                    </div>
                    <button class="btn btn-gray btn-block" onclick="closeUpdateDialog()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
        <div id="quiz-view" class="hidden">
            <div class="card">
                <div id="fav-btn" class="fav-btn" onclick="toggleFav()">â˜†</div>
                <div id="remove-wrong-btn" class="remove-btn hidden" onclick="removeThisWrong()">ğŸ—‘ï¸ ç§»é™¤</div>
                <div id="q-meta" style="font-size:12px; color:#999"></div>
                <div id="q-type" style="font-size:12px; color:#666; margin-bottom:10px; padding:5px; background:#f0f0f0; border-radius:5px; display:inline-block"></div>
                <div id="q-body" style="font-size:18px; margin:15px 0; font-weight: bold; line-height: 1.5; padding-right:30px;"></div>
                <div id="opts-box"></div>
                <div id="ans-box" class="hidden" style="background: #f8f9fa; padding: 15px; border-radius: 10px; color: var(--success); margin-top:15px; border-left: 4px solid var(--success);"></div>

                <div id="action-buttons" style="margin-top: 15px;">
                    <div id="multi-confirm" class="hidden"><button class="btn btn-red btn-block" onclick="checkMulti()">ç¡®è®¤æäº¤</button></div>
                    <div id="show-answer-box" class="hidden"><button class="btn btn-orange btn-block" onclick="toggleShowAnswer()">ğŸ’¡ æ˜¾ç¤ºç­”æ¡ˆ</button></div>
                </div>

                <div style="display:flex; gap:10px; margin-top:20px">
                    <button class="btn btn-gray" style="flex:1" onclick="prev()">ä¸Šä¸€é¢˜</button>
                    <button class="btn btn-blue" style="flex:1" onclick="next()">ä¸‹ä¸€é¢˜</button>
                </div>

                <!-- è€ƒè¯•äº¤å·æŒ‰é’® -->
                <div id="exam-submit-box" class="hidden" style="margin-top: 15px;">
                    <button class="btn btn-green btn-block" onclick="submitExam()">ç»“æŸè€ƒè¯•å¹¶äº¤å·</button>
                </div>

                <!-- ç­”é¢˜å¡ç½‘æ ¼ -->
                <div id="nav-grid" class="nav-grid"></div>
            </div>
            <button class="btn btn-block" style="background:none; color:#999; font-size: 14px;" onclick="backToMenu()">è¿”å›èœå•</button>
        </div>
    </div>
</div>

<script>
    const SALT = "XIAO_FANG_2024_PRO";
    let currentQuestions = [], pool = [], cur = 0, currentCate = '';
    let examAnswers = {};
    let multiSelections = [];

    let deviceId = localStorage.getItem('fixed_sid') || ("SN-" + Math.random().toString(36).slice(2,10).toUpperCase());
    localStorage.setItem('fixed_sid', deviceId);
    document.getElementById('my-device-id-display').innerText = deviceId;

    function copyDeviceId() {
        const input = document.createElement('textarea');
        input.value = deviceId; document.body.appendChild(input);
        input.select(); document.execCommand('copy');
        document.body.removeChild(input);
        alert("åºåˆ—å·å·²å¤åˆ¶ï¼");
    }

    async function login() {
        const name = document.getElementById('uname').value.trim();
        const code = document.getElementById('upass').value.trim();
        const remember = document.getElementById('remember-me').checked;
        if(!name || !code) return alert("è¯·è¾“å…¥å§“åå’Œæˆæƒç ");

        try {
            function safeAtob(str) {
                return decodeURIComponent(escape(window.atob(str)));
            }
            const decoded = safeAtob(code);
            const parts = decoded.split('|');
            if(parts.length < 4) return alert("æˆæƒç æ ¼å¼é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜");
            const [authName, authCourse, authSid, authHash] = parts;

            if(authName !== name) return alert("æˆæƒç å§“åä¸åŒ¹é…");
            if(authSid !== deviceId) return alert("åºåˆ—å·ä¸åŒ¹é…ï¼Œéæˆæƒè®¾å¤‡");
            if(simpleHash(authName + authCourse + authSid + SALT) !== authHash) return alert("æˆæƒç é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜");

            if(remember) {
                localStorage.setItem('rem_name', name);
                localStorage.setItem('rem_code', code);
                localStorage.setItem('is_rem', 'true');
            } else {
                localStorage.removeItem('is_rem');
            }

            sessionStorage.setItem('is_logged', 'true');
            sessionStorage.setItem('cur_user', name);
            sessionStorage.setItem('auth_course', authCourse);
            initUser(name, authCourse);
        } catch(e) { alert("æˆæƒç é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜"); }
    }

    function initUser(name, course) {
        document.getElementById('login-page').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');
        document.getElementById('welcome-name').innerText = name;
        const switcher = document.getElementById('cate-switcher');
        if(course === "3") switcher.classList.remove('hidden'); else switcher.classList.add('hidden');
        switchCate(course === "2" ? 'wb' : 'jk');
    }

    function switchCate(cate) {
        currentCate = cate;
        document.getElementById('sub-title').innerText = (cate==='jk'?'ä¸­çº§-ç›‘æ§å²—':'ä¸­çº§-ç»´ä¿å²—');
        const rawData = localStorage.getItem('db_qs_' + cate);
        currentQuestions = rawData ? JSON.parse(rawData) : [];
        renderHistory();
    }

    function renderHistory() {
        const history = JSON.parse(localStorage.getItem('history_' + currentCate) || '[]');
        const container = document.getElementById('history-list');
        if(history.length === 0) {
            container.innerText = 'æš‚æ— è®°å½•';
            return;
        }
        container.innerHTML = history.slice().reverse().map((h, i) => `
            <div class="history-item" onclick="showHistoryDetail(${history.length - 1 - i})">
                <span>ğŸ“… ${h.date}</span>
                <b style="color:var(--primary)">${h.score}åˆ†</b>
            </div>
        `).join('');
    }

    function showHistoryDetail(index) {
        const history = JSON.parse(localStorage.getItem('history_' + currentCate) || '[]');
        const record = history[index];
        if(!record || !record.wrongs || record.wrongs.length === 0) {
            return alert('æ»¡åˆ†é€šè¿‡ï¼Œæ— é”™é¢˜è®°å½•ï¼');
        }
        const container = document.getElementById('wrong-questions-container');
        container.innerHTML = record.wrongs.map((q, i) => {
            // è·å–é¢˜å‹æ–‡æœ¬
            let typeText = '';
            switch(q.t) {
                case 'single':
                    typeText = 'å•é€‰é¢˜';
                    break;
                case 'multi':
                    typeText = 'å¤šé€‰é¢˜';
                    break;
                case 'judge':
                    typeText = 'åˆ¤æ–­é¢˜';
                    break;
                default:
                    typeText = 'æœªçŸ¥é¢˜å‹';
            }
            
            // ç”Ÿæˆé€‰é¡¹HTML
            const optionsHtml = q.o.map((opt, j) => {
                const lab = ['A','B','C','D','E'][j];
                const isCorrect = q.a.includes(lab);
                return `<div class="${isCorrect ? 'sel-ok' : ''}"><b>${lab}.</b> ${opt}</div>`;
            }).join('');
            
            return `
                <div class="wrong-list-item">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">${typeText}</div>
                    <div class="wrong-q-body">${i+1}. ${q.q}</div>
                    <div style="margin: 10px 0;">${optionsHtml}</div>
                    <div class="wrong-q-ans">âœ… æ­£ç¡®ç­”æ¡ˆï¼š${q.a}</div>
                </div>
            `;
        }).join('');
        document.getElementById('history-detail-page').classList.remove('hidden');
    }

    function closeHistoryDetail() {
        document.getElementById('history-detail-page').classList.add('hidden');
    }

    function showImportSyncMenu() {
        document.getElementById('local-file-input').click();
    }

    function handleLocalFile(input) {
        const file = input.files[0];
        if(!file) return;
        const overlay = document.getElementById('loading-overlay');
        overlay.classList.remove('hidden');
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            // æŒ‰é¢˜ç›®åˆ†å—ï¼ŒåŒ¹é…æ•°å­—å¼€å¤´çš„é¢˜ç›®
            const blocks = content.split(/(?:\n|^)\s*\d+[\.ã€\s\)]+/).filter(s => s.trim());
            let parsed = [];
            blocks.forEach((b, i) => {
                let cleanB = b.replace(/\r\n/g, '\n').trim();
                
                // æå–ç­”æ¡ˆ
                const ansMatch = cleanB.match(/æ­£ç¡®ç­”æ¡ˆ[:ï¼š\s]*([A-Eæ­£ç¡®é”™è¯¯]+)/);
                let answer = ansMatch ? ansMatch[1].trim() : "A";
                cleanB = cleanB.replace(/æ­£ç¡®ç­”æ¡ˆ[:ï¼š\s]*[A-Eæ­£ç¡®é”™è¯¯]+/, "").trim();
                
                let qText = cleanB, options = [];
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å«æ¢è¡Œç¬¦ï¼Œåˆ¤æ–­æ˜¯å¤šè¡Œæ ¼å¼è¿˜æ˜¯å•è¡Œæ ¼å¼
                if (cleanB.includes('\n')) {
                    // å¤šè¡Œæ ¼å¼ï¼šé—®é¢˜åœ¨ç¬¬ä¸€è¡Œï¼Œé€‰é¡¹åœ¨åç»­è¡Œ
                    const lines = cleanB.split('\n').filter(l=>l.trim());
                    if (lines.length > 0) {
                        qText = lines[0];
                        // å¤„ç†é€‰é¡¹è¡Œ
                        lines.slice(1).forEach(line => {
                            // åŒ¹é…é€‰é¡¹æ ¼å¼ï¼šAé€‰é¡¹å†…å®¹
                            const optMatch = line.match(/^[A-E][\.ã€\s]*(.+)/);
                            if (optMatch) {
                                options.push(optMatch[1].trim());
                            }
                        });
                    }
                } else {
                    // å•è¡Œæ ¼å¼ï¼šé—®é¢˜å’Œé€‰é¡¹åœ¨åŒä¸€è¡Œ
                    // æå–é—®é¢˜éƒ¨åˆ†ï¼ˆç¬¬ä¸€ä¸ªé€‰é¡¹å‰çš„å†…å®¹ï¼‰
                    const firstOptIndex = cleanB.search(/[A-E][\.ã€\s]+/);
                    if (firstOptIndex > 0) {
                        qText = cleanB.substring(0, firstOptIndex).trim();
                        
                        // æå–é€‰é¡¹
                        const optRegex = /([A-E])[\.ã€\s]+([^A-E]+?)(?=[A-E][\.ã€\s]+|$)/g;
                        let match;
                        while ((match = optRegex.exec(cleanB)) !== null) {
                            options.push(match[2].trim());
                        }
                    }
                }
                
                // ç¡®ä¿é€‰é¡¹ä¸ä¸ºç©º
                if (options.length === 0) {
                    // å¦‚æœæ²¡æœ‰æå–åˆ°é€‰é¡¹ï¼Œå°è¯•å¦ä¸€ç§æ–¹æ³•
                    const allOptRegex = /[A-E][\.ã€\s]+([^A-E]+)/g;
                    let match;
                    while ((match = allOptRegex.exec(cleanB)) !== null) {
                        options.push(match[1].trim());
                    }
                }
                
                // åˆ¤æ–­é¢˜å‹
                let type = 'single';
                if (options.length === 2) {
                    // é€‰é¡¹åªæœ‰ä¸¤ä¸ªæ—¶åˆ¤å®šä¸ºåˆ¤æ–­é¢˜
                    type = 'judge';
                } else if (answer.length > 1 && /^[A-E]+$/.test(answer)) {
                    // ç­”æ¡ˆæœ‰å¤šä¸ªé€‰é¡¹æ—¶åˆ¤å®šä¸ºå¤šé€‰é¢˜
                    type = 'multi';
                } else {
                    // å…¶ä»–æƒ…å†µåˆ¤å®šä¸ºå•é€‰é¢˜
                    type = 'single';
                }
                
                parsed.push({ id: 'q_'+currentCate+'_'+i+'_'+Date.now(), q: qText, o: options, a: answer, t: type });
            });
            localStorage.setItem('db_qs_' + currentCate, JSON.stringify(parsed));
            currentQuestions = parsed;
            overlay.classList.add('hidden');
            alert('å¯¼å…¥æˆåŠŸï¼Œå…± ' + parsed.length + ' é¢˜');
        };
        reader.readAsText(file);
    }

    function start(m) {
        // å…ˆæ£€æŸ¥å½“å‰é¢˜åº“æ˜¯å¦æœ‰æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‡æ–°ä»æœ¬åœ°å­˜å‚¨åŠ è½½
        if(!currentQuestions || currentQuestions.length === 0) {
            const rawData = localStorage.getItem('db_qs_' + currentCate);
            currentQuestions = rawData ? JSON.parse(rawData) : [];
            if(currentQuestions.length === 0) return alert('è¯·å…ˆç‚¹å‡»[å¯¼å…¥é¢˜åº“]');
        }
        mode = m; cur = 0; examAnswers = {};

        if (m === 'exam') {
            // ä¸¥æ ¼æŒ‰ç…§è¦æ±‚æŠ½å–é¢˜ç›®ï¼šå•é€‰é¢˜100é“ï¼Œå¤šé€‰é¢˜40é“ï¼Œåˆ¤æ–­é¢˜60é“
            let singles = currentQuestions.filter(q => q.t === 'single');
            let multis = currentQuestions.filter(q => q.t === 'multi');
            let judges = currentQuestions.filter(q => q.t === 'judge');
            
            // æ‰“ä¹±é¡ºåº
            singles = singles.sort(()=>0.5-Math.random());
            multis = multis.sort(()=>0.5-Math.random());
            judges = judges.sort(()=>0.5-Math.random());
            
            // æŠ½å–é¢˜ç›®ï¼Œå½“æ•°é‡ä¸è¶³æ—¶è¿›è¡Œæ‹¼å‡‘
            const targetSingles = 100;
            const targetMultis = 40;
            const targetJudges = 60;
            
            // å¤„ç†å•é€‰é¢˜
            let selectedSingles = singles.slice(0, targetSingles);
            if (selectedSingles.length < targetSingles) {
                // å¦‚æœå•é€‰é¢˜ä¸è¶³ï¼Œç”¨å…¶ä»–é¢˜å‹è¡¥å……
                const remaining = targetSingles - selectedSingles.length;
                const otherQuestions = [...multis, ...judges].sort(()=>0.5-Math.random()).slice(0, remaining);
                selectedSingles = [...selectedSingles, ...otherQuestions];
            }
            
            // å¤„ç†å¤šé€‰é¢˜
            let selectedMultis = multis.slice(0, targetMultis);
            if (selectedMultis.length < targetMultis) {
                // å¦‚æœå¤šé€‰é¢˜ä¸è¶³ï¼Œç”¨å…¶ä»–é¢˜å‹è¡¥å……
                const remaining = targetMultis - selectedMultis.length;
                const otherQuestions = [...singles, ...judges].sort(()=>0.5-Math.random()).slice(0, remaining);
                selectedMultis = [...selectedMultis, ...otherQuestions];
            }
            
            // å¤„ç†åˆ¤æ–­é¢˜
            let selectedJudges = judges.slice(0, targetJudges);
            if (selectedJudges.length < targetJudges) {
                // å¦‚æœåˆ¤æ–­é¢˜ä¸è¶³ï¼Œç”¨å…¶ä»–é¢˜å‹è¡¥å……
                const remaining = targetJudges - selectedJudges.length;
                const otherQuestions = [...singles, ...multis].sort(()=>0.5-Math.random()).slice(0, remaining);
                selectedJudges = [...selectedJudges, ...otherQuestions];
            }
            
            pool = [...selectedSingles, ...selectedMultis, ...selectedJudges];
        } else {
            pool = m.includes('random') ? [...currentQuestions].sort(()=>0.5-Math.random()) : [...currentQuestions];
        }

        if(m === 'wrong') pool = JSON.parse(localStorage.getItem('wrongs_'+currentCate) || '[]');
        if(m === 'fav') pool = JSON.parse(localStorage.getItem('favs_'+currentCate) || '[]');

        if(!pool.length) return alert('å†…å®¹ä¸ºç©º');

        document.getElementById('home-view').classList.add('hidden');
        document.getElementById('quiz-view').classList.remove('hidden');
        document.getElementById('remove-wrong-btn').classList.toggle('hidden', mode !== 'wrong');

        if(mode === 'exam') {
            document.getElementById('exam-submit-box').classList.remove('hidden');
            document.getElementById('nav-grid').classList.remove('hidden');
        } else {
            document.getElementById('exam-submit-box').classList.add('hidden');
            document.getElementById('nav-grid').classList.add('hidden');
        }
        render();
    }

    function render() {
        const q = pool[cur];
        const fv = JSON.parse(localStorage.getItem('favs_'+currentCate) || '[]');
        const isFav = fv.some(f => f.q === q.q);
        document.getElementById('fav-btn').innerText = isFav ? 'â­' : 'â˜†';
        document.getElementById('fav-btn').className = isFav ? 'fav-btn active' : 'fav-btn';

        document.getElementById('q-meta').innerText = `${cur+1}/${pool.length}`;
        
        // æ˜¾ç¤ºé¢˜ç›®ç±»å‹
        const qTypeElement = document.getElementById('q-type');
        let typeText = '';
        switch(q.t) {
            case 'single':
                typeText = 'å•é€‰é¢˜';
                break;
            case 'multi':
                typeText = 'å¤šé€‰é¢˜';
                break;
            case 'judge':
                typeText = 'åˆ¤æ–­é¢˜';
                break;
            default:
                typeText = 'æœªçŸ¥é¢˜å‹';
        }
        qTypeElement.innerText = typeText;
        
        document.getElementById('q-body').innerText = q.q;
        const box = document.getElementById('opts-box');
        box.innerHTML = ''; box.classList.remove('lock');
        document.getElementById('ans-box').classList.add('hidden');
        
        // æ˜¾ç¤ºç­”æ¡ˆæŒ‰é’®ï¼šåœ¨ç»ƒä¹ æ¨¡å¼å’Œé”™é¢˜æœ¬æ¨¡å¼ä¸­æ˜¾ç¤º
        const showAnswerBox = document.getElementById('show-answer-box');
        if(mode.includes('practice') || mode.includes('wrong')) {
            showAnswerBox.classList.remove('hidden');
        } else {
            showAnswerBox.classList.add('hidden');
        }
        
        if(mode.includes('memorize')) { document.getElementById('ans-box').innerHTML = "ç­”æ¡ˆï¼š"+q.a; document.getElementById('ans-box').classList.remove('hidden'); box.classList.add('lock'); }
        q.o.forEach((txt, i) => {
            const lab = ['A','B','C','D','E'][i];
            const d = document.createElement('div');
            d.className = 'opt';

            if(mode === 'exam' && examAnswers[cur] === lab) d.classList.add('selected');

            d.innerHTML = `<b>${lab}.</b> ${txt}`;
            if(mode.includes('memorize') && q.a.includes(lab)) d.classList.add('sel-ok');

            d.onclick = () => {
                if(box.classList.contains('lock')) return;

                if(mode === 'exam') {
                    Array.from(box.children).forEach(c => c.classList.remove('selected'));
                    d.classList.add('selected');
                    examAnswers[cur] = lab;
                    renderNavGrid();
                } else {
                    if(lab === q.a) {
                        d.classList.add('sel-ok');
                        box.classList.add('lock');
                        setTimeout(next, 800);
                    } else {
                        d.classList.add('sel-no');
                        saveWrong(q);
                        box.classList.add('lock');
                        ansBox.innerHTML = "<b>é”™è¯¯ï¼æ­£ç¡®ç­”æ¡ˆï¼š</b>" + q.a;
                        ansBox.classList.remove('hidden');
                    }
                }
                if(mode === 'exam') renderNavGrid();
            };
            box.appendChild(d);
        });
        if(mode === 'exam') renderNavGrid();
    }

    function checkMulti() {
        const q = pool[cur];
        if(mode === 'exam') { next(); return; }
        const box = document.getElementById('opts-box');
        const ansBox = document.getElementById('ans-box');
        box.classList.add('lock');
        document.getElementById('multi-confirm').classList.add('hidden');
        const userAns = multiSelections.sort().join('');
        const correctAns = q.a.split('').sort().join('');
        if(userAns === correctAns) {
            Array.from(box.children).forEach((d, i) => { if(q.a.includes(['A','B','C','D','E'][i])) d.classList.add('sel-ok'); });
            setTimeout(next, 800);
        } else {
            saveWrong(q);
            Array.from(box.children).forEach((d, i) => {
                const lab = ['A','B','C','D','E'][i];
                if(q.a.includes(lab)) d.classList.add('sel-ok');
                else if(multiSelections.includes(lab)) d.classList.add('sel-no');
            });
            ansBox.innerHTML = "<b>é”™è¯¯ï¼æ­£ç¡®ç­”æ¡ˆï¼š</b>" + q.a;
            ansBox.classList.remove('hidden');
        }
    }

    function submitExam() {
        if(!confirm('ç¡®å®šè¦äº¤å·å—ï¼Ÿ')) return;
        let score = 0;
        let wrongsList = [];
        pool.forEach((q, i) => {
            const userAns = examAnswers[i] || '';
            const correctAns = q.a.split('').sort().join('');
            if(userAns === correctAns) { score += 0.5; }
            else { wrongsList.push(q); if(userAns !== '') saveWrong(q); }
        });
        const record = { date: new Date().toLocaleString(), score: score.toFixed(1), wrongs: wrongsList };
        const history = JSON.parse(localStorage.getItem('history_' + currentCate) || '[]');
        history.push(record);
        localStorage.setItem('history_' + currentCate, JSON.stringify(history));
        
        console.log('è€ƒè¯•ç»“æŸï¼Œå‡†å¤‡ä¸Šä¼ æˆç»©:', record.score, 'é”™é¢˜æ•°:', wrongsList.length);
        // è‡ªåŠ¨ä¸Šä¼ æˆç»©åˆ°Giteeï¼ˆå¯¹å­¦å‘˜é€æ˜ï¼Œä¸æ˜¾ç¤ºæç¤ºï¼‰
        autoUploadScore(record.score, wrongsList.length);
        
        alert('è€ƒè¯•ç»“æŸï¼æ‚¨çš„å¾—åˆ†ï¼š' + record.score);
        backToMenu();
    }

    // è‡ªåŠ¨ä¸Šä¼ æˆç»©åˆ°Giteeå’ŒGitHub
    function autoUploadScore(score, wrongCount) {
        try {
            console.log('å¼€å§‹ä¸Šä¼ æˆç»©ï¼Œå¾—åˆ†:', score, 'é”™é¢˜æ•°:', wrongCount);
            
            // ç§»é™¤ç½‘ç»œè¿æ¥æ£€æŸ¥ï¼Œç›´æ¥å°è¯•ä¸Šä¼ 
            // ç½‘ç»œè¿æ¥é—®é¢˜ä¼šåœ¨fetchè¯·æ±‚æ—¶è‡ªåŠ¨å¤„ç†
            
            // å‡†å¤‡æˆç»©æ•°æ®
            const studentName = sessionStorage.getItem('cur_user') || 'æœªçŸ¥å­¦å‘˜';
            const course = sessionStorage.getItem('auth_course');
            const courseName = course === '1' ? 'ä¸­çº§-ç›‘æ§å²—' : course === '2' ? 'ä¸­çº§-æ¶ˆé˜²ç»´ä¿' : 'å…¨èƒ½é€š';
            const category = currentCate === 'jk' ? 'ç›‘æ§å²—' : 'æ¶ˆé˜²ç»´ä¿';
            const examDate = new Date().toLocaleString();

            const scoreData = {
                name: studentName,
                deviceId: deviceId,
                course: courseName,
                date: examDate,
                score: score,
                totalQuestions: 200,
                wrongCount: wrongCount,
                category: category
            };
            
            console.log('æˆç»©æ•°æ®å‡†å¤‡å®Œæˆ:', scoreData);

            // å°è¯•ä¸Šä¼ åˆ°Gitee
            const giteeConfig = JSON.parse(localStorage.getItem('gitee_config') || '{}');
            console.log('Giteeé…ç½®:', giteeConfig);
            if (giteeConfig.owner && giteeConfig.repo && giteeConfig.path && giteeConfig.token) {
                uploadWithRetry('gitee', giteeConfig, scoreData, 3);
            } else {
                console.log('Giteeé…ç½®ä¸å®Œæ•´ï¼Œè·³è¿‡ä¸Šä¼ ');
            }
            
            // å°è¯•ä¸Šä¼ åˆ°GitHub
            const githubConfig = JSON.parse(localStorage.getItem('github_config') || '{}');
            console.log('GitHubé…ç½®:', githubConfig);
            if (githubConfig.owner && githubConfig.repo && githubConfig.path && githubConfig.token) {
                uploadWithRetry('github', githubConfig, scoreData, 3);
            } else {
                console.log('GitHubé…ç½®ä¸å®Œæ•´ï¼Œè·³è¿‡ä¸Šä¼ ');
            }
        } catch (error) {
            // ä¸Šä¼ å¤±è´¥ä¸å½±å“ç”¨æˆ·ä½“éªŒï¼Œé™é»˜å¤„ç†
            console.log('æˆç»©ä¸Šä¼ å¤±è´¥:', error);
        }
    }
    
    // æ·»åŠ é‡è¯•æœºåˆ¶
    async function uploadWithRetry(platform, config, scoreData, retryCount) {
        for (let i = 0; i < retryCount; i++) {
            try {
                if (platform === 'gitee') {
                    await uploadScoreToGitee(config, scoreData);
                } else if (platform === 'github') {
                    await uploadScoreToGithub(config, scoreData);
                }
                console.log(`${platform}ä¸Šä¼ æˆåŠŸ`);
                // æ¸…é™¤å¾…ä¸Šä¼ çš„æˆç»©
                localStorage.removeItem('pending_score');
                return true;
            } catch (error) {
                console.log(`${platform}ä¸Šä¼ å¤±è´¥ï¼Œç¬¬${i+1}æ¬¡é‡è¯•:`, error);
                if (i === retryCount - 1) {
                    // æœ€åä¸€æ¬¡é‡è¯•å¤±è´¥ï¼Œå­˜å‚¨åˆ°æœ¬åœ°
                    localStorage.setItem('pending_score', JSON.stringify(scoreData));
                    console.log(`${platform}ä¸Šä¼ å¤±è´¥ï¼Œå·²å­˜å‚¨åˆ°æœ¬åœ°`);
                }
                // ç­‰å¾…1ç§’åé‡è¯•
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }
        return false;
    }
    
    // æ£€æŸ¥å¹¶ä¸Šä¼ å¾…å¤„ç†çš„æˆç»©
    function checkPendingScore() {
        const pendingScore = localStorage.getItem('pending_score');
        if (pendingScore) {
            try {
                const scoreData = JSON.parse(pendingScore);
                
                // å°è¯•ä¸Šä¼ åˆ°Gitee
                const giteeConfig = JSON.parse(localStorage.getItem('gitee_config') || '{}');
                if (giteeConfig.owner && giteeConfig.repo && giteeConfig.path && giteeConfig.token) {
                    uploadWithRetry('gitee', giteeConfig, scoreData, 3);
                }
                
                // å°è¯•ä¸Šä¼ åˆ°GitHub
                const githubConfig = JSON.parse(localStorage.getItem('github_config') || '{}');
                if (githubConfig.owner && githubConfig.repo && githubConfig.path && githubConfig.token) {
                    uploadWithRetry('github', githubConfig, scoreData, 3);
                }
            } catch (error) {
                console.log('å¤„ç†å¾…ä¸Šä¼ æˆç»©å¤±è´¥:', error);
            }
        }
    }

    // ä¸Šä¼ æˆç»©åˆ°Gitee
    async function uploadScoreToGitee(config, scoreData) {
        try {
            // æ„å»ºAPI URL
            const apiUrl = `https://gitee.com/api/v5/repos/${config.owner}/${config.repo}/contents/${config.path}/${scoreData.name}_${scoreData.deviceId.substring(0, 8)}.json`;
            console.log('Giteeä¸Šä¼ URL:', apiUrl);

            // è¯»å–ç°æœ‰æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            let existingContent = '';
            let sha = '';
            
            try {
                // å‡†å¤‡è¯·æ±‚å¤´ï¼ˆæ·»åŠ è®¤è¯ï¼‰
                const getHeaders = {
                    'Accept': 'application/json'
                };
                if (config.token) {
                    getHeaders['Authorization'] = `token ${config.token}`;
                }
                
                console.log('Giteeè¯»å–æ–‡ä»¶...');
                const getResponse = await fetch(apiUrl, {
                    headers: getHeaders
                });
                
                console.log('Giteeè¯»å–å“åº”çŠ¶æ€:', getResponse.status);
                if (getResponse.ok) {
                    const existingData = await getResponse.json();
                    existingContent = atob(existingData.content);
                    sha = existingData.sha;
                    console.log('Giteeæ–‡ä»¶å·²å­˜åœ¨ï¼ŒSHA:', sha);
                } else if (getResponse.status === 404) {
                    // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°æ–‡ä»¶
                    console.log('Giteeæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°æ–‡ä»¶');
                } else {
                    const errorText = await getResponse.text();
                    throw new Error(`Giteeè¯»å–æ–‡ä»¶å¤±è´¥: ${getResponse.status} - ${errorText}`);
                }
            } catch (e) {
                // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°æ–‡ä»¶
                console.log('Giteeè¯»å–æ–‡ä»¶æ—¶å‡ºé”™:', e);
            }

            // è§£æç°æœ‰æ•°æ®
            let studentData = {
                name: scoreData.name,
                deviceId: scoreData.deviceId,
                course: scoreData.course,
                scores: []
            };

            if (existingContent) {
                try {
                    studentData = JSON.parse(existingContent);
                    console.log('Giteeè§£æç°æœ‰æ•°æ®æˆåŠŸï¼Œå†å²æˆç»©æ•°:', studentData.scores.length);
                } catch (e) {
                    // è§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
                    console.log('Giteeè§£ææ–‡ä»¶å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®:', e);
                }
            }

            // æ·»åŠ æ–°æˆç»©
            studentData.scores.push({
                date: scoreData.date,
                score: scoreData.score,
                totalQuestions: scoreData.totalQuestions,
                wrongCount: scoreData.wrongCount,
                category: scoreData.category
            });
            console.log('Giteeæ·»åŠ æ–°æˆç»©åï¼Œæ€»æˆç»©æ•°:', studentData.scores.length);

            // å‡†å¤‡ä¸Šä¼ æ•°æ®
            const uploadData = {
                content: btoa(JSON.stringify(studentData, null, 2)),
                message: `æ›´æ–°${scoreData.name}çš„æˆç»©`,
                branch: config.branch || 'master'
            };

            if (sha) {
                uploadData.sha = sha;
            }

            // å‡†å¤‡ä¸Šä¼ è¯·æ±‚å¤´ï¼ˆæ·»åŠ è®¤è¯ï¼‰
            const uploadHeaders = {
                'Content-Type': 'application/json'
            };
            if (config.token) {
                uploadHeaders['Authorization'] = `token ${config.token}`;
            }

            // å‘é€è¯·æ±‚
            console.log('Giteeå¼€å§‹ä¸Šä¼ ...');
            const response = await fetch(apiUrl, {
                method: sha ? 'PUT' : 'POST',
                headers: uploadHeaders,
                body: JSON.stringify(uploadData)
            });

            console.log('Giteeä¸Šä¼ å“åº”çŠ¶æ€:', response.status);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Giteeä¸Šä¼ å¤±è´¥: ${response.status} - ${errorText}`);
            }

            const responseData = await response.json();
            console.log('Giteeä¸Šä¼ æˆåŠŸ:', responseData.commit.sha);
            return true;
        } catch (error) {
            // ä¸Šä¼ å¤±è´¥ä¸å½±å“ç”¨æˆ·ä½“éªŒï¼Œä½†æ˜¯è®°å½•è¯¦ç»†é”™è¯¯
            console.error('Giteeä¸Šä¼ å¤±è´¥:', error);
            throw error;
        }
    }
    
    // ä¸Šä¼ æˆç»©åˆ°GitHub
    async function uploadScoreToGithub(config, scoreData) {
        try {
            // æ„å»ºAPI URL
            const apiUrl = `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${config.path}/${scoreData.name}_${scoreData.deviceId.substring(0, 8)}.json`;
            console.log('GitHubä¸Šä¼ URL:', apiUrl);

            // è¯»å–ç°æœ‰æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            let existingContent = '';
            let sha = '';
            
            try {
                // å‡†å¤‡è¯·æ±‚å¤´ï¼ˆæ·»åŠ è®¤è¯ï¼‰
                const getHeaders = {
                    'Accept': 'application/vnd.github.v3+json'
                };
                if (config.token) {
                    getHeaders['Authorization'] = `token ${config.token}`;
                }
                
                console.log('GitHubè¯»å–æ–‡ä»¶...');
                const getResponse = await fetch(apiUrl, {
                    headers: getHeaders
                });
                
                console.log('GitHubè¯»å–å“åº”çŠ¶æ€:', getResponse.status);
                if (getResponse.ok) {
                    const existingData = await getResponse.json();
                    existingContent = atob(existingData.content);
                    sha = existingData.sha;
                    console.log('GitHubæ–‡ä»¶å·²å­˜åœ¨ï¼ŒSHA:', sha);
                } else if (getResponse.status === 404) {
                    // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°æ–‡ä»¶
                    console.log('GitHubæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°æ–‡ä»¶');
                } else {
                    const errorText = await getResponse.text();
                    throw new Error(`GitHubè¯»å–æ–‡ä»¶å¤±è´¥: ${getResponse.status} - ${errorText}`);
                }
            } catch (e) {
                // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°æ–‡ä»¶
                console.log('GitHubè¯»å–æ–‡ä»¶æ—¶å‡ºé”™:', e);
            }

            // è§£æç°æœ‰æ•°æ®
            let studentData = {
                name: scoreData.name,
                deviceId: scoreData.deviceId,
                course: scoreData.course,
                scores: []
            };

            if (existingContent) {
                try {
                    studentData = JSON.parse(existingContent);
                    console.log('GitHubè§£æç°æœ‰æ•°æ®æˆåŠŸï¼Œå†å²æˆç»©æ•°:', studentData.scores.length);
                } catch (e) {
                    // è§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
                    console.log('GitHubè§£ææ–‡ä»¶å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®:', e);
                }
            }

            // æ·»åŠ æ–°æˆç»©
            studentData.scores.push({
                date: scoreData.date,
                score: scoreData.score,
                totalQuestions: scoreData.totalQuestions,
                wrongCount: scoreData.wrongCount,
                category: scoreData.category
            });
            console.log('GitHubæ·»åŠ æ–°æˆç»©åï¼Œæ€»æˆç»©æ•°:', studentData.scores.length);

            // å‡†å¤‡ä¸Šä¼ æ•°æ®
            const uploadData = {
                content: btoa(JSON.stringify(studentData, null, 2)),
                message: `æ›´æ–°${scoreData.name}çš„æˆç»©`,
                branch: config.branch || 'main'
            };

            if (sha) {
                uploadData.sha = sha;
            }

            // å‡†å¤‡ä¸Šä¼ è¯·æ±‚å¤´ï¼ˆæ·»åŠ è®¤è¯ï¼‰
            const uploadHeaders = {
                'Content-Type': 'application/json',
                'Accept': 'application/vnd.github.v3+json'
            };
            if (config.token) {
                uploadHeaders['Authorization'] = `token ${config.token}`;
            }

            // å‘é€è¯·æ±‚
            console.log('GitHubå¼€å§‹ä¸Šä¼ ...');
            const response = await fetch(apiUrl, {
                method: sha ? 'PUT' : 'PUT', // GitHubä½¿ç”¨PUTåˆ›å»ºå’Œæ›´æ–°
                headers: uploadHeaders,
                body: JSON.stringify(uploadData)
            });

            console.log('GitHubä¸Šä¼ å“åº”çŠ¶æ€:', response.status);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`GitHubä¸Šä¼ å¤±è´¥: ${response.status} - ${errorText}`);
            }

            const responseData = await response.json();
            console.log('GitHubä¸Šä¼ æˆåŠŸ:', responseData.commit.sha);
            return true;
        } catch (error) {
            // ä¸Šä¼ å¤±è´¥ä¸å½±å“ç”¨æˆ·ä½“éªŒï¼Œä½†æ˜¯è®°å½•è¯¦ç»†é”™è¯¯
            console.error('GitHubä¸Šä¼ å¤±è´¥:', error);
            throw error;
        }
    }

    function renderNavGrid() {
        const grid = document.getElementById('nav-grid');
        grid.innerHTML = pool.map((_, i) => `<div class="nav-item ${examAnswers[i] ? 'done' : ''} ${cur === i ? 'current' : ''}" onclick="jumpTo(${i})">${i + 1}</div>`).join('');
    }

    function jumpTo(i) { cur = i; render(); }
    function toggleFav() { const q = pool[cur]; let fv = JSON.parse(localStorage.getItem('favs_'+currentCate) || '[]'); const idx = fv.findIndex(f => f.q === q.q); if(idx > -1) fv.splice(idx, 1); else fv.push(q); localStorage.setItem('favs_'+currentCate, JSON.stringify(fv)); render(); }
    function saveWrong(q) { let wr = JSON.parse(localStorage.getItem('wrongs_'+currentCate) || '[]'); if(!wr.some(x => x.q === q.q)) { wr.push(q); localStorage.setItem('wrongs_'+currentCate, JSON.stringify(wr)); } }
    function removeThisWrong() { if(!confirm('ç§»é™¤ï¼Ÿ')) return; const q = pool[cur]; let wr = JSON.parse(localStorage.getItem('wrongs_'+currentCate) || '[]'); const idx = wr.findIndex(x => x.q === q.q); if(idx > -1) { wr.splice(idx, 1); localStorage.setItem('wrongs_'+currentCate, JSON.stringify(wr)); pool.splice(cur, 1); if(!pool.length) backToMenu(); else { if(cur>=pool.length) cur=pool.length-1; render(); } } }
    function toggleShowAnswer() { const ans = document.getElementById('ans-box'); ans.innerHTML = "<b>æ­£ç¡®ç­”æ¡ˆï¼š</b>"+pool[cur].a; ans.classList.toggle('hidden'); }
    function next() { if(cur < pool.length-1) { cur++; render(); } }
    function prev() { if(cur > 0) { cur--; render(); } }
    function logout() { if(confirm('æ³¨é”€ï¼Ÿ')) { sessionStorage.clear(); location.reload(); } }
    function backToMenu() { document.getElementById('quiz-view').classList.add('hidden'); document.getElementById('home-view').classList.remove('hidden'); renderHistory(); }

    function doGenerateCode() {
        const name = document.getElementById('gen-name').value.trim();
        const sid = document.getElementById('gen-sid').value.trim();
        const course = document.getElementById('gen-course').value;
        if(!name || !sid) { alert("è¯·å¡«å†™å®Œæ•´å§“åå’Œåºåˆ—å·"); return; }

        try {
            function safeBtoa(str) { return window.btoa(unescape(encodeURIComponent(str))); }
            const h = simpleHash(name + course + sid + SALT);
            const combined = name + "|" + course + "|" + sid + "|" + h;
            const code = safeBtoa(combined).replace(/=/g, "");
            document.getElementById('result-box').classList.remove('hidden');
            document.getElementById('code-text').innerText = code;
        } catch(e) { alert("ç”Ÿæˆå¤±è´¥"); }
    }

    function copyCode() { const text = document.getElementById('code-text').innerText; const input = document.createElement('textarea'); input.value = text; document.body.appendChild(input); input.select(); document.execCommand('copy'); document.body.removeChild(input); alert("å·²å¤åˆ¶ï¼"); }
    function goHomeFromAdmin() { document.getElementById('admin-page').classList.add('hidden'); document.getElementById('login-page').classList.remove('hidden'); }

    // æ ¸å¿ƒå“ˆå¸Œç®—æ³• (ä¿æŒç»å¯¹ä¸€è‡´)
    function simpleHash(str) {
        let h = 0;
        for (let i = 0; i < str.length; i++) {
            h = ((h << 5) - h) + str.charCodeAt(i);
            h |= 0;
        }
        return Math.abs(h).toString(36).toUpperCase();
    }

    function showAdmin() { if(prompt('ç®¡ç†å¯†ç ') === 'admin888') { document.getElementById('login-page').classList.add('hidden'); document.getElementById('admin-page').classList.remove('hidden'); } }

    // æˆç»©ç®¡ç†ç›¸å…³å‡½æ•°
    function showScoreManagement() {
        const adminPage = document.getElementById('admin-page');
        adminPage.innerHTML = `
            <h2 style="color: var(--secondary)">ğŸ“Š æˆç»©ç®¡ç†ä¸­å¿ƒ (ç®¡ç†å‘˜)</h2>
            
            <!-- Giteeé…ç½® -->
            <div class="card" style="width: 100%; box-sizing: border-box;">
                <h4>âš™ï¸ Giteeé…ç½®</h4>
                <p style="font-size: 12px; color: #666; margin-bottom: 15px;">è®¾ç½®Giteeä»“åº“ä¿¡æ¯ï¼Œå­¦å‘˜è€ƒè¯•åä¼šè‡ªåŠ¨ä¸Šä¼ æˆç»©</p>
                <input type="text" id="gitee-owner" placeholder="Giteeç”¨æˆ·å/ç»„ç»‡å">
                <input type="text" id="gitee-repo" placeholder="ä»“åº“åç§°">
                <input type="text" id="gitee-path" placeholder="æ–‡ä»¶å­˜å‚¨è·¯å¾„ (å¦‚: scores)">
                <input type="text" id="gitee-branch" placeholder="åˆ†æ”¯åç§° (é»˜è®¤: master)">
                <button class="btn btn-blue btn-block" onclick="saveGiteeConfig()">ä¿å­˜é…ç½®</button>
                <div id="gitee-config-result" class="hidden" style="margin-top: 15px; padding: 10px; background: #d1fae5; border-radius: 8px; font-size: 12px;">
                    é…ç½®ä¿å­˜æˆåŠŸï¼å­¦å‘˜è€ƒè¯•åå°†è‡ªåŠ¨ä¸Šä¼ æˆç»©
                </div>
            </div>
            
            <!-- æŸ¥çœ‹å­¦å‘˜æˆç»© -->
            <div class="card" style="width: 100%; box-sizing: border-box; margin-top: 20px;">
                <h4>ğŸ“ˆ æŸ¥çœ‹å­¦å‘˜æˆç»©</h4>
                <p style="font-size: 12px; color: #666; margin-bottom: 15px;">é€šè¿‡GiteeæŸ¥çœ‹æ‰€æœ‰å­¦å‘˜çš„è€ƒè¯•æˆç»©</p>
                <button class="btn btn-green btn-block" onclick="openGiteeRepo()">æ‰“å¼€Giteeä»“åº“</button>
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 12px;">
                    <p><strong>ä½¿ç”¨è¯´æ˜ï¼š</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>1. é…ç½®Giteeä»“åº“ä¿¡æ¯</li>
                        <li>2. å­¦å‘˜è€ƒè¯•åä¼šè‡ªåŠ¨ä¸Šä¼ æˆç»©ï¼Œå¯¹å­¦å‘˜é€æ˜</li>
                        <li>3. åœ¨Giteeä»“åº“ä¸­æŸ¥çœ‹æ‰€æœ‰å­¦å‘˜çš„æˆç»©è®°å½•</li>
                        <li>4. æ¯ä¸ªå­¦å‘˜çš„æˆç»©ä»¥å•ç‹¬çš„JSONæ–‡ä»¶å­˜å‚¨</li>
                    </ul>
                </div>
            </div>
            
            <button class="btn btn-gray btn-block" style="margin-top: 20px;" onclick="goHomeFromAdmin()">è¿”å›ç®¡ç†ä¸­å¿ƒ</button>
        `;
        
        // åŠ è½½ç°æœ‰é…ç½®
        loadGiteeConfig();
    }

    function loadGiteeConfig() {
        const config = JSON.parse(localStorage.getItem('gitee_config') || '{}');
        if (config.owner) document.getElementById('gitee-owner').value = config.owner;
        if (config.repo) document.getElementById('gitee-repo').value = config.repo;
        if (config.path) document.getElementById('gitee-path').value = config.path;
        if (config.branch) document.getElementById('gitee-branch').value = config.branch;
    }

    function saveGiteeConfig() {
        const owner = document.getElementById('gitee-owner').value.trim();
        const repo = document.getElementById('gitee-repo').value.trim();
        const path = document.getElementById('gitee-path').value.trim();
        const branch = document.getElementById('gitee-branch').value.trim() || 'master';
        
        if (!owner || !repo || !path) {
            return alert('è¯·å¡«å†™å®Œæ•´çš„Giteeé…ç½®ä¿¡æ¯');
        }
        
        const config = {
            owner: owner,
            repo: repo,
            path: path,
            branch: branch
        };
        
        localStorage.setItem('gitee_config', JSON.stringify(config));
        document.getElementById('gitee-config-result').classList.remove('hidden');
        
        // 3ç§’åéšè—æç¤º
        setTimeout(() => {
            document.getElementById('gitee-config-result').classList.add('hidden');
        }, 3000);
    }

    function openGiteeRepo() {
        const config = JSON.parse(localStorage.getItem('gitee_config') || '{}');
        if (!config.owner || !config.repo) {
            return alert('è¯·å…ˆé…ç½®Giteeä»“åº“ä¿¡æ¯');
        }
        
        const repoUrl = `https://gitee.com/${config.owner}/${config.repo}/tree/${config.branch || 'master'}/${config.path || ''}`;
        window.open(repoUrl, '_blank');
    }

    // æ›´æ–°é¢˜åº“ç›¸å…³å‡½æ•°
    function showUpdateDialog() {
        const updateDialog = document.getElementById('updateDialog');
        const authCourse = sessionStorage.getItem('auth_course');
        
        // æ ¹æ®ç”¨æˆ·æƒé™æ˜¾ç¤ºå¯¹åº”çš„æ›´æ–°æŒ‰é’®
        const jkButton = updateDialog.querySelector('button[onclick="updateExam(\'jk\')"]');
        const wbButton = updateDialog.querySelector('button[onclick="updateExam(\'wb\')"]');
        
        if (authCourse === '1') {
            // åªæœ‰ç›‘æ§å²—æƒé™
            jkButton.style.display = 'block';
            wbButton.style.display = 'none';
        } else if (authCourse === '2') {
            // åªæœ‰ç»´ä¿å²—æƒé™
            jkButton.style.display = 'none';
            wbButton.style.display = 'block';
        } else if (authCourse === '3') {
            // å…¨èƒ½é€šæƒé™
            jkButton.style.display = 'block';
            wbButton.style.display = 'block';
        }
        
        updateDialog.classList.remove('hidden');
    }

    function closeUpdateDialog() {
        document.getElementById('updateDialog').classList.add('hidden');
    }

    async function updateExam(cate) {
        const overlay = document.getElementById('loading-overlay');
        overlay.classList.remove('hidden');
        document.getElementById('loading-txt').innerText = 'æ­£åœ¨ä¸‹è½½é¢˜åº“...';
        document.getElementById('progress-txt').innerText = '0%';
        document.getElementById('progress-inner').style.width = '0%';

        try {
            // è¿™é‡Œæ›¿æ¢ä¸ºå®é™…çš„GitHub Gist URL
            const urls = {
                'jk': 'https://gist.githubusercontent.com/a990154649/1631c3a76605006b9934a2dc1492cb32/raw/jiankongzhongji.txt',
                'wb': 'https://gist.githubusercontent.com/a990154649/55b1d5f67c69870dc4bc2de68b428cf8/raw/weibaozhongji.txt'
            };

            // CORSä»£ç†æœåŠ¡ä½œä¸ºå¤‡ç”¨
            const corsProxy = 'https://cors-anywhere.herokuapp.com/';

            console.log('å¼€å§‹æ›´æ–°é¢˜åº“:', cate);
            console.log('è¯·æ±‚URL:', urls[cate]);

            // ä½¿ç”¨ä¸åŒçš„fetché…ç½®ï¼Œæ·»åŠ æ›´å¤šçš„é”™è¯¯å¤„ç†
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30ç§’è¶…æ—¶

            let response;
            let content;
            
            // å°è¯•ç›´æ¥è¯·æ±‚
            try {
                response = await fetch(urls[cate], {
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Accept': 'text/plain',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
                    },
                    signal: controller.signal
                });
                
                if (response.ok) {
                    content = await response.text();
                    console.log('ç›´æ¥è¯·æ±‚æˆåŠŸï¼Œå†…å®¹é•¿åº¦:', content.length);
                } else {
                    console.log('ç›´æ¥è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç :', response.status);
                    throw new Error('ç›´æ¥è¯·æ±‚å¤±è´¥');
                }
            } catch (firstError) {
                console.log('ç›´æ¥è¯·æ±‚å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å¤‡ç”¨URL:', firstError.message);
                
                // å°è¯•ä½¿ç”¨å¤‡ç”¨URLï¼ˆGitHub Rawï¼‰
                const backupUrls = {
                    'jk': 'https://raw.githubusercontent.com/a990154649/xiaotitong/main/jiankongzhongji.txt',
                    'wb': 'https://raw.githubusercontent.com/a990154649/xiaotitong/main/weibaozhongji.txt'
                };
                
                try {
                    const backupController = new AbortController();
                    const backupTimeoutId = setTimeout(() => backupController.abort(), 30000);
                    
                    const backupResponse = await fetch(backupUrls[cate], {
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Accept': 'text/plain',
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
                        },
                        signal: backupController.signal
                    });
                    
                    clearTimeout(backupTimeoutId);
                    
                    if (backupResponse.ok) {
                        content = await backupResponse.text();
                        console.log('å¤‡ç”¨URLè¯·æ±‚æˆåŠŸï¼Œå†…å®¹é•¿åº¦:', content.length);
                    } else {
                        console.log('å¤‡ç”¨URLè¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç :', backupResponse.status);
                        throw new Error(`å¤‡ç”¨URLè¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${backupResponse.status}`);
                    }
                } catch (backupError) {
                    console.log('å¤‡ç”¨URLè¯·æ±‚å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨CORSä»£ç†:', backupError.message);
                    
                    // å°è¯•ä½¿ç”¨CORSä»£ç†
                    try {
                        const proxyUrl = corsProxy + urls[cate];
                        console.log('ä½¿ç”¨CORSä»£ç†:', proxyUrl);
                        
                        const proxyController = new AbortController();
                        const proxyTimeoutId = setTimeout(() => proxyController.abort(), 30000);
                        
                        const proxyResponse = await fetch(proxyUrl, {
                            headers: {
                                'Cache-Control': 'no-cache',
                                'Accept': 'text/plain',
                                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
                            },
                            signal: proxyController.signal
                        });
                        
                        clearTimeout(proxyTimeoutId);
                        
                        if (proxyResponse.ok) {
                            content = await proxyResponse.text();
                            console.log('CORSä»£ç†è¯·æ±‚æˆåŠŸï¼Œå†…å®¹é•¿åº¦:', content.length);
                        } else {
                            console.log('CORSä»£ç†è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç :', proxyResponse.status);
                            throw new Error(`CORSä»£ç†è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${proxyResponse.status}`);
                        }
                    } catch (proxyError) {
                        throw new Error('æ‰€æœ‰è¯·æ±‚æ–¹å¼éƒ½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–å°è¯•å…¶ä»–ç½‘ç»œç¯å¢ƒ');
                    }
                }
            } finally {
                clearTimeout(timeoutId);
            }

            console.log('è¯·æ±‚æˆåŠŸï¼Œå¼€å§‹è§£æé¢˜åº“...');

            const blocks = content.split(/(?:\n|^)\s*\d+[\.ã€\s\)]+/).filter(s => s.trim());
            console.log('è§£æå‡ºçš„é¢˜ç›®æ•°é‡:', blocks.length);

            let parsed = [];

            blocks.forEach((b, i) => {
                let cleanB = b.replace(/\r\n/g, '\n').trim();
                
                // æå–ç­”æ¡ˆ
                const ansMatch = cleanB.match(/æ­£ç¡®ç­”æ¡ˆ[:ï¼š\s]*([A-Eæ­£ç¡®é”™è¯¯]+)/);
                let answer = ansMatch ? ansMatch[1].trim() : "A";
                cleanB = cleanB.replace(/æ­£ç¡®ç­”æ¡ˆ[:ï¼š\s]*[A-Eæ­£ç¡®é”™è¯¯]+/, "").trim();
                
                let qText = cleanB, options = [];
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å«æ¢è¡Œç¬¦ï¼Œåˆ¤æ–­æ˜¯å¤šè¡Œæ ¼å¼è¿˜æ˜¯å•è¡Œæ ¼å¼
                if (cleanB.includes('\n')) {
                    // å¤šè¡Œæ ¼å¼ï¼šé—®é¢˜åœ¨ç¬¬ä¸€è¡Œï¼Œé€‰é¡¹åœ¨åç»­è¡Œ
                    const lines = cleanB.split('\n').filter(l=>l.trim());
                    if (lines.length > 0) {
                        qText = lines[0];
                        // å¤„ç†é€‰é¡¹è¡Œ
                        lines.slice(1).forEach(line => {
                            // åŒ¹é…é€‰é¡¹æ ¼å¼ï¼šAé€‰é¡¹å†…å®¹
                            const optMatch = line.match(/^[A-E][\.ã€\s]*(.+)/);
                            if (optMatch) {
                                options.push(optMatch[1].trim());
                            }
                        });
                    }
                } else {
                    // å•è¡Œæ ¼å¼ï¼šé—®é¢˜å’Œé€‰é¡¹åœ¨åŒä¸€è¡Œ
                    // æå–é—®é¢˜éƒ¨åˆ†ï¼ˆç¬¬ä¸€ä¸ªé€‰é¡¹å‰çš„å†…å®¹ï¼‰
                    const firstOptIndex = cleanB.search(/[A-E][\.ã€\s]+/);
                    if (firstOptIndex > 0) {
                        qText = cleanB.substring(0, firstOptIndex).trim();
                        
                        // æå–é€‰é¡¹
                        const optRegex = /([A-E])[\.ã€\s]+([^A-E]+?)(?=[A-E][\.ã€\s]+|$)/g;
                        let match;
                        while ((match = optRegex.exec(cleanB)) !== null) {
                            options.push(match[2].trim());
                        }
                    }
                }
                
                // ç¡®ä¿é€‰é¡¹ä¸ä¸ºç©º
                if (options.length === 0) {
                    // å¦‚æœæ²¡æœ‰æå–åˆ°é€‰é¡¹ï¼Œå°è¯•å¦ä¸€ç§æ–¹æ³•
                    const allOptRegex = /[A-E][\.ã€\s]+([^A-E]+)/g;
                    let match;
                    while ((match = allOptRegex.exec(cleanB)) !== null) {
                        options.push(match[1].trim());
                    }
                }
                
                // åˆ¤æ–­é¢˜å‹
                let type = 'single';
                if (options.length === 2) {
                    // é€‰é¡¹åªæœ‰ä¸¤ä¸ªæ—¶åˆ¤å®šä¸ºåˆ¤æ–­é¢˜
                    type = 'judge';
                } else if (answer.length > 1 && /^[A-E]+$/.test(answer)) {
                    // ç­”æ¡ˆæœ‰å¤šä¸ªé€‰é¡¹æ—¶åˆ¤å®šä¸ºå¤šé€‰é¢˜
                    type = 'multi';
                } else {
                    // å…¶ä»–æƒ…å†µåˆ¤å®šä¸ºå•é€‰é¢˜
                    type = 'single';
                }
                
                parsed.push({ id: 'q_'+cate+'_'+i+'_'+Date.now(), q: qText, o: options, a: answer, t: type });
                
                // æ›´æ–°è¿›åº¦
                const progress = Math.round(((i + 1) / blocks.length) * 100);
                document.getElementById('progress-txt').innerText = progress + '%';
                document.getElementById('progress-inner').style.width = progress + '%';
            });

            localStorage.setItem('db_qs_' + cate, JSON.stringify(parsed));
            if(cate === currentCate) {
                currentQuestions = parsed;
            }

            console.log('é¢˜åº“ä¿å­˜æˆåŠŸï¼Œé¢˜ç›®æ•°é‡:', parsed.length);

            overlay.classList.add('hidden');
            alert('æ›´æ–°æˆåŠŸï¼Œå…± ' + parsed.length + ' é¢˜');
            closeUpdateDialog();
        } catch(e) {
            console.error('æ›´æ–°é¢˜åº“å¤±è´¥:', e);
            overlay.classList.add('hidden');
            if (e.name === 'AbortError') {
                alert('æ›´æ–°å¤±è´¥ï¼šä¸‹è½½è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            } else if (e.message.includes('Failed to fetch')) {
                alert('æ›´æ–°å¤±è´¥ï¼šç½‘ç»œè¿æ¥é—®é¢˜ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•\nå¯èƒ½æ˜¯CORSé™åˆ¶å¯¼è‡´ï¼Œè¯·å°è¯•ä½¿ç”¨ä»£ç†æˆ–æ›´æ¢ç½‘ç»œç¯å¢ƒ');
            } else {
                alert('æ›´æ–°å¤±è´¥ï¼š' + e.message);
            }
            closeUpdateDialog();
        }
    }

    window.onload = function() {
        // è‡ªåŠ¨é…ç½®Giteeä¿¡æ¯ï¼ˆé¦–æ¬¡å¯åŠ¨æ—¶ï¼‰
        if (!localStorage.getItem('gitee_config')) {
            const defaultGiteeConfig = {
                owner: 'zhaoyun119119', // Giteeç”¨æˆ·å
                repo: 'xiaotitong', // ä»“åº“åç§°
                path: 'xiaotitong', // å­˜å‚¨è·¯å¾„
                branch: 'master', // åˆ†æ”¯åç§°
                token: 'f6584da25c3b398768216bcf4d09871c' // Giteeç§äººä»¤ç‰Œ
            };
            localStorage.setItem('gitee_config', JSON.stringify(defaultGiteeConfig));
            console.log('Giteeé…ç½®å·²è‡ªåŠ¨è®¾ç½®');
        }
        
        // è‡ªåŠ¨é…ç½®GitHubä¿¡æ¯ï¼ˆé¦–æ¬¡å¯åŠ¨æ—¶ï¼‰
        if (!localStorage.getItem('github_config')) {
            const defaultGithubConfig = {
                owner: 'a990154649', // GitHubç”¨æˆ·å
                repo: 'xiaotitong', // ä»“åº“åç§°
                path: 'xiaotitong', // å­˜å‚¨è·¯å¾„
                branch: 'main', // åˆ†æ”¯åç§°ï¼ˆGitHubé»˜è®¤æ˜¯mainï¼‰
                token: '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' // GitHubè®¿é—®ä»¤ç‰Œ
            };
            localStorage.setItem('github_config', JSON.stringify(defaultGithubConfig));
            console.log('GitHubé…ç½®å·²è‡ªåŠ¨è®¾ç½®');
        }
        
        // æ£€æŸ¥å¾…ä¸Šä¼ çš„æˆç»©
        checkPendingScore();
        
        // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
        window.addEventListener('online', function() {
            console.log('ç½‘ç»œå·²è¿æ¥ï¼Œæ£€æŸ¥å¾…ä¸Šä¼ æˆç»©');
            checkPendingScore();
        });
        
        if(sessionStorage.getItem('is_logged')) initUser(sessionStorage.getItem('cur_user'), sessionStorage.getItem('auth_course'));
        else if(localStorage.getItem('is_rem') === 'true') {
            document.getElementById('uname').value = localStorage.getItem('rem_name') || '';
            document.getElementById('upass').value = localStorage.getItem('rem_code') || '';
            document.getElementById('remember-me').checked = true;
        }
    }
</script>
</body>
</html>
